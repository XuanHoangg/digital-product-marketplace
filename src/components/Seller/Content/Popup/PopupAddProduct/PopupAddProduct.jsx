import React, { useState } from "react";
import styles from "./PopupAddProduct.module.scss";
import { useSelector } from "react-redux";

import { postAddProduct } from "@service/seller/product/productAPI";
import { toast } from "react-toastify";

import { convertFileToBase64 } from "@utils/helper.js";
const PopupAddProduct = ({ onClose, storeId, categories }) => {
  const userId = useSelector((state) => state?.auth?.account?.userId);

  const [formData, setFormData] = useState({
    productName: "",
    category: "",
    price: "",
    description: "",
    sumaryFeature: "",
    images: [],
  });

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleImageChange = async (e) => {
    const files = Array.from(e.target.files);
    const base64Images = await Promise.all(
      files.map((file) => convertFileToBase64(file))
    );
    setFormData((prev) => ({
      ...prev,
      images: base64Images,
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      const payload = {
        sellerId: userId,
        storeId: storeId,
        productName: formData.productName,
        description: formData.description,
        categoryId: formData.category,
        originalPrice: parseFloat(formData.price),
        sumaryFeature: formData.sumaryFeature,
        images: formData.images,
      };

      console.log("Payload to send:", payload);
      const data = await postAddProduct(payload);
      if (data.status === 0) {
        toast.success(data.messageResult + data.data);
      }
      if (data.status === 3) {
        toast.error(data.messageResult);
      }
      console.log("Response data:", data);

      // onClose();
    } catch (error) {
      console.error("L·ªói th√™m s·∫£n ph·∫©m:", error);
    }
  };
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  return (
    <div className={styles.popupOverlay} onClick={handleOverlayClick}>
      <div className={styles.popupContainer}>
        <div className={styles.popupHeader}>
          <h2 className={styles.popupTitle}>Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
          <button className={styles.closeBtn} onClick={onClose}>
            √ó
          </button>
        </div>

        <form className={styles.popupForm} onSubmit={handleSubmit}>
          {/* T√™n s·∫£n ph·∫©m */}
          <div className={styles.formRow}>
            <div className={styles.formGroup}>
              <label className={styles.formLabel}>T√™n s·∫£n ph·∫©m</label>
              <input
                type="text"
                name="productName"
                className={styles.formInput}
                placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..."
                value={formData.productName}
                onChange={handleInputChange}
                required
              />
            </div>
          </div>

          {/* Danh m·ª•c & Gi√° */}
          <div className={styles.formRow}>
            <div className={`${styles.formGroup} ${styles.halfWidth}`}>
              <label className={styles.formLabel}>Danh m·ª•c</label>
              <select
                name="category"
                className={styles.formSelect}
                value={formData.category}
                onChange={handleInputChange}
                required
              >
                <option value="">Ch·ªçn danh m·ª•c</option>

                {categories.map((category) => (
                  <option key={category.id} value={category.id}>
                    {category.name}
                  </option>
                ))}
              </select>
            </div>
            <div className={`${styles.formGroup} ${styles.halfWidth}`}>
              <label className={styles.formLabel}>Gi√°</label>
              <input
                type="number"
                name="price"
                className={styles.formInput}
                placeholder="VD: 1250000"
                value={formData.price}
                onChange={handleInputChange}
                required
              />
            </div>
          </div>

          {/* ·∫¢nh */}
          <div className={styles.formRow}>
            <div className={styles.formGroup}>
              <label className={styles.formLabel}>H√¨nh ·∫£nh (nhi·ªÅu)</label>

              <div className={styles.imageGroup}>
                <label
                  htmlFor="image-upload"
                  className={styles.imageUploadLabel}
                >
                  üìÅ Ch·ªçn h√¨nh ·∫£nh
                </label>
                <input
                  id="image-upload"
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={handleImageChange}
                  className={styles.imageUploadInput}
                />
              </div>

              {formData.images.length > 0 && (
                <div className={styles.previewContainer}>
                  {formData.images.map((img, idx) => (
                    <img
                      key={idx}
                      src={img}
                      alt={`preview-${idx}`}
                      className={styles.previewImage}
                    />
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* M√¥ t·∫£ */}
          <div className={styles.formRow}>
            <div className={styles.formGroup}>
              <label className={styles.formLabel}>M√¥ t·∫£</label>
              <textarea
                name="description"
                className={styles.formTextarea}
                placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m..."
                rows="4"
                value={formData.description}
                onChange={handleInputChange}
              ></textarea>
            </div>
          </div>

          {/* T√≠nh nƒÉng n·ªïi b·∫≠t */}
          <div className={styles.formGroup}>
            <label className={styles.formLabel}>T√≠nh nƒÉng n·ªïi b·∫≠t</label>
            <input
              type="text"
              name="sumaryFeature"
              className={styles.formInput}
              placeholder="VD: Thi·∫øt k·∫ø ƒë·∫πp, d·ªÖ d√πng..."
              value={formData.sumaryFeature}
              onChange={handleInputChange}
            />
          </div>

          {/* Actions */}
          <div className={styles.popupActions}>
            <button
              type="button"
              className={styles.cancelBtn}
              onClick={onClose}
            >
              H·ªßy
            </button>
            <button type="submit" className={styles.submitBtn}>
              Th√™m S·∫£n Ph·∫©m
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default PopupAddProduct;
